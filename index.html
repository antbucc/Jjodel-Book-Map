<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>MDE + Jjodel Learning Flow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:1.5rem}
    #chart{width:100%;height:80vh;border:1px dashed #ddd;border-radius:10px}
    .row{margin:.5rem 0}
    label{font-weight:600}
    input{width:100%}
    button{padding:.5rem .8rem;margin-top:.25rem}
    pre{white-space:pre-wrap;background:#f6f8fa;padding:.5rem;border-radius:6px}
  </style>
</head>
<body>
  <h1>MDE + Jjodel — Chapter-level Sankey</h1>

  <div class="row">
    <label>CSV URL (Google Sheets “Publish to web → CSV” or GitHub raw):</label>
    <input id="csvUrl" placeholder="https://drive.google.com/file/d/1ifz26EtJPuEyOlZUAzkwkYBNF6O3ASBP/view?usp=sharing?output=csv">
    <!-- Optional: prefill your CSV -->
    <!-- <script>document.getElementById('csvUrl').value='https://docs.google.com/spreadsheets/d/e/.../pub?output=csv'</script> -->
  </div>
  <button id="loadBtn">Load</button>
  <pre id="status"></pre>
  <div id="chart"></div>

<script>
async function fetchCSV(url){
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error(`Fetch ${res.status} ${res.statusText}`);
  return await res.text();
}
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const headers = lines.shift().split(",").map(h=>h.trim());
  return lines.map(line=>{
    const cells = line.split(",").map(c=>c.trim());
    const row={};
    headers.forEach((h,i)=>row[h]=cells[i]??"");
    return row;
  });
}
function chapterLabel(ch){
  ch=String(ch||"");
  const parts=ch.split(" ",2);
  return `Ch${parts[0]} ${(parts[1]||"").slice(0,32)}`.trim();
}
function buildSankey(rows){
  const chapters=[];
  rows.forEach(r=>{
    const ch=(r.chapter||"").trim();
    if(ch && !chapters.includes(ch)) chapters.push(ch);
  });
  const idx=Object.fromEntries(chapters.map((c,i)=>[c,i]));
  const id2ch={};
  rows.forEach(r=>{
    const id=(r.id||"").trim(),ch=(r.chapter||"").trim();
    if(id && ch) id2ch[id]=ch;
  });
  const counts={};
  rows.forEach(r=>{
    const dst=(r.chapter||"").trim();
    const pre=(r.prereq||"").trim();
    if(pre && pre.toLowerCase()!=="nan"){
      pre.split(",").map(s=>s.trim()).filter(Boolean).forEach(p=>{
        const src=id2ch[p];
        if(src && src!==dst){
          const key=src+"→"+dst;
          counts[key]=(counts[key]||0)+1;
        }
      });
    }
  });
  const sources=[],targets=[],values=[];
  Object.entries(counts).forEach(([k,v])=>{
    const [a,b]=k.split("→");
    if(a in idx && b in idx){sources.push(idx[a]);targets.push(idx[b]);values.push(v);}
  });
  if(values.length===0 && chapters.length){sources.push(0);targets.push(0);values.push(1);}
  return{
    data:[{type:"sankey",arrangement:"snap",
      node:{label:chapters.map(chapterLabel),pad:18,thickness:16},
      link:{source:sources,target:targets,value:values}}],
    layout:{title:"MDE + Jjodel Learning Flow (Static CSV)"}
  };
}
async function run(){
  const url=document.getElementById("csvUrl").value.trim();
  const status=document.getElementById("status");
  status.textContent="Loading CSV...";
  try{
    const text=await fetchCSV(url);
    const rows=parseCSV(text);
    const fig=buildSankey(rows);
    Plotly.newPlot("chart",fig.data,fig.layout,{responsive:true});
    status.textContent="Loaded from: "+url;
  }catch(e){status.textContent="Error: "+e.message;}
}
document.getElementById("loadBtn").addEventListener("click",run);
</script>
</body>
</html>
